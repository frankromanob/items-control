"use strict";(()=>{var e={};e.id=684,e.ids=[684],e.modules={46517:e=>{e.exports=require("lodash")},99226:e=>{e.exports=require("lodash/assign")},59283:e=>{e.exports=require("lodash/at")},20770:e=>{e.exports=require("lodash/clone")},59591:e=>{e.exports=require("lodash/cloneDeep")},39131:e=>{e.exports=require("lodash/compact")},77047:e=>{e.exports=require("lodash/difference")},48390:e=>{e.exports=require("lodash/extend")},9368:e=>{e.exports=require("lodash/filter")},22265:e=>{e.exports=require("lodash/first")},43160:e=>{e.exports=require("lodash/functions")},74292:e=>{e.exports=require("lodash/identity")},41238:e=>{e.exports=require("lodash/includes")},35599:e=>{e.exports=require("lodash/isArray")},99965:e=>{e.exports=require("lodash/isElement")},89699:e=>{e.exports=require("lodash/isEmpty")},25716:e=>{e.exports=require("lodash/isFunction")},27078:e=>{e.exports=require("lodash/isNumber")},75795:e=>{e.exports=require("lodash/isObject")},15452:e=>{e.exports=require("lodash/isPlainObject")},97026:e=>{e.exports=require("lodash/isString")},22133:e=>{e.exports=require("lodash/isUndefined")},83824:e=>{e.exports=require("lodash/last")},53707:e=>{e.exports=require("lodash/map")},61831:e=>{e.exports=require("lodash/merge")},11516:e=>{e.exports=require("lodash/take")},75142:e=>{e.exports=require("lodash/trim")},11185:e=>{e.exports=require("mongoose")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},71017:e=>{e.exports=require("path")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},80642:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>x,originalPathname:()=>q,patchFetch:()=>S,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>v});var s={};r.r(s),r.d(s,{DELETE:()=>g,GET:()=>u,POST:()=>p,PUT:()=>m});var o=r(10884),a=r(16132),i=r(21040),n=r(25999),l=r(59471),d=r(11185),c=r(9636);async function u(){await n.db.connect();let e=await l.Z.find().sort({title:"asc"}).lean();await n.db.disconnect();let t=e.map(e=>(e.images=e.images.map(e=>e.includes("http")?e:`${process.env.HOST_NAME}/${e}`),e));return Response.json(t)}async function p(e){let t=await e.json(),{id:r="",title:s="",description:o="",slug:a="",tags:i="",pv:d=0,bv:c=0,ibo:u=0,costo:p=0,inStock:m=0,sizes:g="",images:y="",type:f=""}=t;await n.db.connect();let h=await l.Z.findOne({slug:a});if(h)return await n.db.disconnect(),console.log("El slug ya existe"),new Response("El slug ya existe",{status:400});let w=new l.Z({title:s,description:o,slug:a,tags:i,sizes:g,images:y,type:f,costo:p,pv:d,bv:c,ibo:u,inStock:m});try{await w.save({validateBeforeSave:!0})}catch(e){return console.log(e),new Response("Error al enviar al servidor",{status:500})}return await n.db.disconnect(),Response.json(w)}async function m(e){let t=await e.json(),{_id:r="",title:s="",description:o="",slug:a="",tags:i=[],pv:u=0,bv:p=0,ibo:m=0,costo:g=0,inStock:y=0,sizes:f="",images:h=[],type:w=""}=t;if(!(0,d.isValidObjectId)(r))return console.log("Id incorrecto"),new Response("Id de product incorrecto",{status:400});await n.db.connect();let x=await l.Z.findById({_id:r});if(!x)return await n.db.disconnect(),console.log("El product no existe"),new Response("El product no existe",{status:400});x.title=s,x.description=o,x.slug=a,x.tags=i,x.sizes=f,x.type=w,x.costo=g,x.pv=u,x.bv=p,x.ibo=m,x.inStock=y;try{x.images.forEach(async e=>{if(!h.includes(e)){console.log("borrar img");let[t,r]=e.substring(e.lastIndexOf("/")+1).split(".");console.log(t),await c.v2.uploader.destroy(t)}})}catch(e){return console.log(e),new Response("No se pudo eliminar la imagen del cloud",{status:500})}x.images=h;try{await x.save({validateBeforeSave:!0})}catch(e){return console.log(e),new Response("Error al enviar al servidor",{status:500})}return await n.db.disconnect(),Response.json(x)}async function g(e){let{productId:t,images:r=[]}=await e.json();if(!(0,d.isValidObjectId)(t))return console.log("Id incorrecto"),new Response("Id de producto incorrecto",{status:400});await n.db.connect();let s=await l.Z.findById({_id:t});if(!s)return await n.db.disconnect(),console.log("El producto no existe"),new Response("El producto no existe",{status:400});try{await s.deleteOne({validateBeforeSave:!0})}catch(e){return console.log(e),new Response("Error al enviar al servidor",{status:500})}try{r.forEach(async e=>{let[t,r]=e.substring(e.lastIndexOf("/")+1).split(".");console.log(t),await c.v2.uploader.destroy(t)})}catch(e){return console.log(e),new Response("No se pudo eliminar la imagen del cloud",{status:500})}return await n.db.disconnect(),Response.json(s)}let y=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/products/route",pathname:"/api/products",filename:"route",bundlePath:"app/api/products/route"},resolvedPagePath:"/Users/altice/RomApps/items-control/src/app/api/products/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:w,headerHooks:x,staticGenerationBailout:v}=y,q="/api/products/route";function S(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},25999:(e,t,r)=>{r.d(t,{db:()=>s,rx:()=>a,N2:()=>o});var s={};r.r(s),r.d(s,{connect:()=>d,disconnect:()=>c});var o={};r.r(o),r.d(o,{i:()=>m});var a={};r.r(a),r.d(a,{decreaseProductQuantity:()=>h,getAllProducts:()=>y,getProductBySlug:()=>f,increaseProductQuantity:()=>w});var i=r(11185),n=r.n(i);let l={isConnected:0},d=async()=>{if(!l.isConnected){if(n().connections.length>0){if(l.isConnected=n().connections[0].readyState,1===l.isConnected)return;await n().disconnect()}await n().connect(process.env.MONGO_URL||""),l.isConnected=1,console.log("Conectado a MongoDB:",process.env.MONGO_URL)}},c=async()=>{0!==l.isConnected&&(await n().disconnect(),l.isConnected=0)};var u=r(62421),p=r.n(u);let m={users:[{name:"Francisco Romano",email:"fromano@google.com",password:p().hashSync("123456"),role:"admin"},{name:"Betilio Romano",email:"bromano@google.com",password:p().hashSync("654321"),role:"client"}]};r(90644);var g=r(59471);let y=async()=>{await d();let e=await g.Z.find().select(" -_id").lean();await c();let t=e.map(e=>(e.images=e.images.map(e=>e.includes("http")?e:`${process.env.HOST_NAME}/${e}`),e));return JSON.parse(JSON.stringify(t))},f=async e=>{await d();let t=await g.Z.findOne({slug:e}).lean();return(await c(),t)?(t.images=t.images.map(e=>e.includes("http")?e:`${process.env.HOST_NAME}/${e}`),JSON.parse(JSON.stringify(t))):null},h=async e=>{await d();try{e.map(async(e,t)=>{let r=await g.Z.findById({_id:e.product});r&&(r.inStock-=Number(e.quantity)),await r.save({validateBeforeSave:!0})})}catch(e){return console.log(e),new Response("Error al rebajar inventario",{status:500})}await c()},w=async(e,t)=>{await d();try{let r=await g.Z.findById({_id:e});r&&(r.inStock+=Number(t),await r.save({validateBeforeSave:!0}))}catch(e){return console.log(e),new Response("Error al incrementar inventario",{status:500})}await c()}},90644:(e,t,r)=>{r.d(t,{Z:()=>n});var s=r(11185),o=r.n(s);let a=new s.Schema({firstName:{type:String,required:!0,default:""},lastName:{type:String,required:!0,default:""},phone:{type:String,required:!0,default:""},email:{type:String,default:""}},{timestamps:!0});a.index({firstName:"text",email:"text"});let i=o().models.Customers||(0,s.model)("Customers",a),n=i},59471:(e,t,r)=>{r.d(t,{Z:()=>n});var s=r(11185),o=r.n(s);let a=new s.Schema({description:{type:String,default:""},images:[{type:String}],default:["",""],inStock:{type:Number,default:0},costo:{type:Number,required:!0,default:0},pv:{type:Number,default:0},bv:{type:Number,default:0},ibo:{type:Number,default:0},slug:{type:String,required:!0,default:"",unique:!0},tags:[{type:String,default:["",""]}],title:{type:String,required:!0},type:{type:String,default:""},sizes:{type:String,default:""}},{timestamps:!0});a.index({title:"text",tags:"text",slug:"text"});let i=o().models.Product||(0,s.model)("Product",a),n=i}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[271,444,272],()=>r(80642));module.exports=s})();